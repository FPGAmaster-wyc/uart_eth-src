#!/bin/sh

APP_DIR=/usr/uart_eth
ETH2UART=eth2uart
UART2ETH=uart2eth

PID_DIR=/var/run
LOG_FILE=/var/log/uart_eth.log
MAX_LOG_SIZE=10485760   # 10MB

rotate_log() {
    if [ -f "$LOG_FILE" ]; then
        size=$(stat -c%s "$LOG_FILE" 2>/dev/null)
        if [ "$size" -gt "$MAX_LOG_SIZE" ]; then
            mv "$LOG_FILE" "$LOG_FILE.old"
        fi
    fi
}

log() {
    echo "$(date '+%F %T') $1" >> "$LOG_FILE"
}

start() {
    rotate_log
    log "========== uart_eth service START =========="

    # ---- eth2uart ----
    if [ -f "$PID_DIR/eth2uart.pid" ] && kill -0 $(cat "$PID_DIR/eth2uart.pid") 2>/dev/null; then
        log "eth2uart already running"
    else
        script -q -f -c "$APP_DIR/$ETH2UART" "$LOG_FILE" &
        echo $! > "$PID_DIR/eth2uart.pid"
        log "eth2uart started (pid $(cat $PID_DIR/eth2uart.pid))"
    fi

    # ---- uart2eth ----
    if [ -f "$PID_DIR/uart2eth.pid" ] && kill -0 $(cat "$PID_DIR/uart2eth.pid") 2>/dev/null; then
        log "uart2eth already running"
    else
        script -q -f -c "$APP_DIR/$UART2ETH" "$LOG_FILE" &
        echo $! > "$PID_DIR/uart2eth.pid"
        log "uart2eth started (pid $(cat $PID_DIR/uart2eth.pid))"
    fi
}

stop() {
    log "========== uart_eth service STOP =========="

    if [ -f "$PID_DIR/eth2uart.pid" ]; then
        kill $(cat "$PID_DIR/eth2uart.pid") 2>/dev/null
        rm -f "$PID_DIR/eth2uart.pid"
        log "eth2uart stopped"
    fi

    if [ -f "$PID_DIR/uart2eth.pid" ]; then
        kill $(cat "$PID_DIR/uart2eth.pid") 2>/dev/null
        rm -f "$PID_DIR/uart2eth.pid"
        log "uart2eth stopped"
    fi
}

status() {
    if [ -f "$PID_DIR/eth2uart.pid" ] && kill -0 $(cat "$PID_DIR/eth2uart.pid") 2>/dev/null; then
        echo "eth2uart running (pid $(cat $PID_DIR/eth2uart.pid))"
    else
        echo "eth2uart not running"
    fi

    if [ -f "$PID_DIR/uart2eth.pid" ] && kill -0 $(cat "$PID_DIR/uart2eth.pid") 2>/dev/null; then
        echo "uart2eth running (pid $(cat $PID_DIR/uart2eth.pid))"
    else
        echo "uart2eth not running"
    fi
}

restart() {
    stop
    sleep 1
    start
}

case "$1" in
    start)
        start
        ;;
    stop)
        stop
        ;;
    restart)
        restart
        ;;
    status)
        status
        ;;
    *)
        echo "Usage: $0 {start|stop|restart|status}"
        exit 1
        ;;
esac

exit 0
